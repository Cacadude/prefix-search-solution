# Архитектура решения

## Обзор

Решение для префиксного поиска по каталогу товаров построено на основе Elasticsearch 8.11 и Flask API. Система обеспечивает высокое покрытие запросов (96.67%) при низкой задержке (67.51 мс).

## Компоненты системы

### 1. Elasticsearch (Поисковый движок)

**Версия**: 8.11.0

**Роль**: 
- Хранение и индексация каталога товаров
- Выполнение поисковых запросов
- Ранжирование результатов

**Конфигурация**:
- Single-node режим (для разработки)
- Отключена безопасность (xpack.security.enabled=false)
- Память: 512MB heap

**Индекс**: `products`
- Количество документов: 1000 товаров
- Шарды: 1
- Реплики: 0 (для разработки)

### 2. Load Catalog Service (Инициализация данных)

**Роль**: 
- Парсинг XML каталога
- Создание индекса с анализаторами
- Загрузка товаров в Elasticsearch

**Особенности**:
- Автоматический запуск при старте Docker Compose
- Retry логика для подключения к Elasticsearch
- Валидация данных перед загрузкой

### 3. Search API Service (REST API)

**Роль**:
- Обработка поисковых запросов
- Нормализация и обработка запросов
- Формирование запросов к Elasticsearch
- Фильтрация результатов

**Технологии**:
- Flask (веб-фреймворк)
- Python 3.11
- Elasticsearch Python client

**Endpoints**:
- `GET /search?query=...&top_k=...` - поиск товаров
- `POST /search` - поиск товаров (JSON body)
- `GET /health` - проверка здоровья сервиса

## Поток данных

```
1. Пользователь вводит запрос
   ↓
2. API получает запрос (GET/POST /search)
   ↓
3. Нормализация запроса:
   - Декодирование URL
   - Удаление лишних пробелов
   - Исправление кодировки
   ↓
4. Обработка запроса:
   - Удаление пробелов для разбитых слов
   - Исправление раскладки (для коротких запросов)
   - Извлечение чисел
   ↓
5. Формирование запроса к Elasticsearch:
   - Multi-match запросы
   - Prefix запросы
   - Wildcard запросы
   - Match phrase prefix
   ↓
6. Выполнение поиска в Elasticsearch
   ↓
7. Фильтрация результатов:
   - Проверка релевантности
   - Проверка совпадения слов
   - Fallback на топовые результаты
   ↓
8. Формирование ответа
   ↓
9. Возврат результатов пользователю
```

## Схема индекса

### Анализаторы

1. **prefix_analyzer**:
   - Токенизатор: standard
   - Фильтры: lowercase → russian_stop → russian_stemmer → edge_ngram_filter
   - Применение: индексация полей name, category, brand, keywords, description

2. **search_analyzer**:
   - Токенизатор: standard
   - Фильтры: lowercase → russian_stop → russian_stemmer
   - Применение: поиск по полям с prefix_analyzer

3. **english_analyzer**:
   - Токенизатор: standard
   - Фильтры: lowercase → edge_ngram_filter
   - Применение: индексация brand.english (без стемминга)

4. **layout_analyzer**:
   - Токенизатор: keyword
   - Char filters: layout_filter (маппинг раскладки)
   - Фильтры: lowercase
   - Применение: индексация name.layout, brand.layout, search_text.layout

### Маппинг полей

```json
{
  "id": "keyword",
  "name": {
    "type": "text",
    "analyzer": "prefix_analyzer",
    "search_analyzer": "search_analyzer",
    "fields": {
      "keyword": "keyword",
      "layout": "text (layout_analyzer)"
    }
  },
  "brand": {
    "type": "text",
    "analyzer": "prefix_analyzer",
    "search_analyzer": "search_analyzer",
    "fields": {
      "keyword": "keyword",
      "english": "text (english_analyzer)",
      "layout": "text (layout_analyzer)"
    }
  },
  "category": {
    "type": "text",
    "analyzer": "prefix_analyzer",
    "search_analyzer": "search_analyzer",
    "fields": {
      "keyword": "keyword"
    }
  },
  "keywords": "text (prefix_analyzer)",
  "description": "text (prefix_analyzer)",
  "search_text": {
    "type": "text",
    "analyzer": "prefix_analyzer",
    "search_analyzer": "search_analyzer",
    "fields": {
      "layout": "text (layout_analyzer)"
    }
  },
  "weight_value": "float",
  "price": "float"
}
```

## Стратегия поиска

### Типы запросов

1. **Multi-match (best_fields)**:
   - Поиск по всем полям с бустами
   - Fuzzy matching для длинных запросов
   - Основной механизм поиска

2. **Multi-match (bool_prefix)**:
   - Префиксный поиск для улучшения покрытия
   - Особенно эффективен для коротких запросов

3. **Prefix queries**:
   - Точный префиксный поиск по keyword полям
   - Высокий буст для точных совпадений

4. **Wildcard queries**:
   - Для очень коротких запросов (1-2 символа)
   - Поиск по name.keyword и brand.keyword

5. **Match phrase prefix**:
   - Для фразовых префиксов
   - Сохраняет порядок слов

6. **Match queries**:
   - Поиск по отдельным словам
   - Для многословных запросов

### Бусты полей

- `name^3` - название товара (самый важный)
- `brand^2.5` - бренд (важный)
- `brand.english^2.5` - бренд на английском
- `keywords^2` - ключевые слова
- `category^1.5` - категория
- `search_text^1.5` - поисковый текст
- `description^1` - описание

## Обработка запросов

### Этапы обработки

1. **Нормализация**:
   - Удаление лишних пробелов
   - Приведение к нижнему регистру
   - Декодирование URL

2. **Исправление кодировки**:
   - Обработка неправильно закодированных запросов
   - Latin-1 → UTF-8 конвертация

3. **Удаление пробелов**:
   - Для разбитых слов ("кар тофель" → "картофель")
   - Только для коротких запросов (≤25 символов)

4. **Исправление раскладки**:
   - Только для коротких запросов (1-3 символа)
   - Только для латинских запросов без кириллицы
   - QWERTY → ЙЦУКЕН маппинг

5. **Извлечение чисел**:
   - Распознавание веса/объема (10л, 5кг, 3 шт)
   - Нормализация единиц измерения
   - Фильтрация по числовым признакам

## Защита от мусора

### Многоуровневая фильтрация

1. **Проверка релевантности**:
   - Минимальный порог убран для максимального покрытия
   - Все результаты от Elasticsearch принимаются

2. **Проверка совпадения слов**:
   - Для длинных запросов: хотя бы одно слово должно совпадать
   - Для коротких запросов: проверка префиксов

3. **Проверка префиксов**:
   - Для коротких запросов (≤2 символа)
   - Проверка начала важных полей (name, brand, category)

4. **Fallback механизм**:
   - Если фильтрация убрала все результаты
   - Возвращаются топовые результаты от Elasticsearch

## Производительность

### Оптимизации

1. **Индексация**:
   - Edge n-gram для префиксного поиска
   - Keyword поля для точных совпадений
   - Отдельные поля для разных типов поиска

2. **Запросы**:
   - Комбинация нескольких типов запросов
   - Бусты для важных полей
   - Ограничение размера результатов (top_k * 3)

3. **Фильтрация**:
   - Минимальная фильтрация для максимального покрытия
   - Fallback на результаты Elasticsearch

### Метрики

- **Покрытие**: 96.67% (58 из 60 запросов)
- **Средняя задержка**: 67.51 мс
- **Размер индекса**: ~1-2 MB
- **Время загрузки данных**: ~5-10 секунд

## Масштабируемость

### Горизонтальное масштабирование

1. **Elasticsearch**:
   - Кластер из 3+ узлов
   - Репликация индексов
   - Шардирование по категориям

2. **API Service**:
   - Несколько инстансов за load balancer
   - Stateless архитектура
   - Кэширование в Redis

### Вертикальное масштабирование

1. **Elasticsearch**:
   - Увеличение heap памяти
   - Больше CPU для обработки запросов

2. **API Service**:
   - Больше памяти для обработки запросов
   - Больше CPU для параллельной обработки

## Безопасность

1. **Аутентификация**: API ключи или OAuth2
2. **Rate limiting**: защита от DDoS
3. **Валидация**: проверка входных данных
4. **HTTPS**: шифрование трафика
5. **Аудит**: логирование всех действий

## Мониторинг

1. **Метрики**: Prometheus + Grafana
2. **Логи**: централизованное логирование (ELK stack)
3. **Трейсинг**: распределенная трассировка (Jaeger)
4. **Алерты**: уведомления о проблемах

